# Как передавать данные о клиентах и заказах из CRM | API Яндекс Метрики

Шаг 1. Подготовка данных для привязки к визитам

## В этой статье:

  1. [API импорта данных](index.md)
  2. Импорт данных о клиентах и заказах из CRM
  3. Упрощенная отправка данных
  4. Настройка упрощенной отправки данных

# Настройка упрощенной отправки данных о клиентах и заказах

## [](ru/data-import/simple-orders-prep#data)Шаг 1. Подготовка данных для привязки к визитам

Метрика привязывает данные из CRM к посетителям и их визитам на сайте. Для привязки Метрика использует характеристики клиентов (`phones`, `emails`, `phones_md5`, `emails_md5`), а также специальный идентификатор [ClientId](https://yandex.../support/metrica/general/clientid-userid.md). Идентификатор Метрики [ClientId](https://yandex.../support/metrica/general/clientid-userid.md) обеспечивает самый высокий уровень привязки заказов к визитам пользователей на сайте — рекомендуем передавать именно его.

**Как настроить передачу ClientID?**

Передача [ClientId](https://yandex.../support/metrica/general/clientid-userid.md) — это процесс включения уникального идентификатора пользователя Метрики в записи о сделках в вашей CRM-системе. Настройте передачу параметра в зависимости от того, как именно происходит контакт с пользователем:

  * **Формы и заказы на сайте**. Получите `ClientId` с помощью JavaScript-метода [getClientID](https://yandex.../support/metrica/objects/get-client-id.md) и запишите его в скрытое поле ваших лид-форм для последующей передачи в CRM.

  * **Звонки посетителей**. Если в вашей CRM сделки создаются после звонков, то, скорее всего, вы используете сервис коллтрекинга. Проверьте, что ваша система коллтрекинга имеет функцию передачи `ClientId` в сделки внутри CRM.

  * **Письма от посетителей**. Для сделок, инициированных через e-mail, используйте сервисы e-mail-трекинга, которые позволяют определить `ClientId` отправителя письма благодаря подмене e-mail-адресов на сайте и отправить информацию о новом письме в вашу CRM в виде сделки.

  * **Чаты в мессенджерах**. При начале общения в мессенджерах инициируйте метод [getClientID](https://yandex.../support/metrica/objects/get-client-id.md) на сайте и включите идентификатор `ClientId` в диплинк (Telegram, Viber) или в шаблон сообщения (WhatsApp). При создании сделки указывайте идентификатор в отдельном поле.

  * **Виджеты на сайте**. Удостоверьтесь, что виджеты, используемые на сайте, могут передавать `ClientId` Метрики в вашу CRM при передаче сделок.

Примечание

Если вы не можете записать идентификатор [ClientId](https://yandex.../support/metrica/general/clientid-userid.md) (например, при покупке в офлайн-точке) или настроить его передачу из своей CRM, используйте опцию Дополнительные настройки отслеживания в настройках счетчика для более точной привязки заказов по e-mail и телефонам.

## [](ru/data-import/simple-orders-prep#csv)Шаг 2. Формирование сsv-файла специального формата

Сформируйте файл в формате упрощенных данных о заказах и клиентах, указав обязательные данные — дату заказа, хотя бы один из идентификаторов (`client_ids`, `emails`, `phones`, `emails_md5`, `phones_md5`) и `id` заказа в вашей CRM, если в будущем вы планируете обновлять этот заказ.

Дополнительно можно отправить идентификатор клиента в CRM, статус заказа (вместе со статусом заказа будут выполняться соответствующие цели) и доход/себестоимость заказа.

[Подробнее про формат упрощенных данных о заказах и клиентах](simple-orders-data.md)

## [](ru/data-import/simple-orders-prep#shag-3-zagruzka-dannyh-v-metriku)Шаг 3. Загрузка данных в Метрику

Передайте данные в Метрику с помощью метода [POST /cdp/api/v1/counter/{counterId}/data/simple_orders](../management/openapi/schema/uploadsimpleorders.md).

Упрощенный метод помогает отправлять в Метрику информацию о заказах и клиентах в CSV-файле без дополнительных настроек ([сопоставления статусов заказов](maporderstatuses-about.md), загрузки отдельных списков [клиентов](contacts-data.md) и [заказов](orders-data.md), загрузки [списка товаров](../management/openapi/schema/createproducts.md) и [дополнительных атрибутов](../management/openapi/schema/createattributes.md)). Для сбора статистики достаточно передавать дату и время создания заказа в часовом поясе счетчика (`create_date_time`) и один из параметров клиентов ([ClientID](https://yandex.../support/metrica/objects/get-client-id.md), номер телефона или адрес электронной почты, хеши телефона или почты). Вы можете передавать заказы в разных статусах с данными о выручке и себестоимости.

Отправленная информация учитывается в отчетах [Сквозной аналитики](../stat/presets/preset_cdp_orders.md). Кроме этого, вы можете использовать данные для ретаргетинга и оптимизации конверсий в Директе.

[Подробно о формате передаваемых данных](simple-orders-data.md)

Примеры загружаемого файла

  * [Загрузка данных по ClientID](https://download.cdn.yandex.net/from/yandex.../support/../metrica/files/simple_orders_client_ids.md). Рекомендуем использовать этот тип идентификатора, так как он обеспечивает более точную привязку загруженных данных с информацией о посетителях сайта в Метрике.
  * [Загрузка данных по адресам электронной почты](https://download.cdn.yandex.net/from/yandex.../support/../metrica/files/simple_orders_emails.md).
  * [Загрузка данных по номерам телефонов](https://download.cdn.yandex.net/from/yandex.../support/../metrica/files/simple_orders_phones.md).
  * [Загрузка в одном файле разных идентификаторов](https://download.cdn.yandex.net/from/yandex.../support/../metrica/files/simple_orders_full.md).

При отправке данных о заказах в параметре `merge_mode` передавайте значение, соответствующее состоянию загружаемых заказов. Если при повторной отправке данных вы не уверены, какой именно статус нужно передавать, укажите значение `SAVE`.

**Пример запроса**
    
    
    POST https://api-metrika.yandex.net/cdp/api/v1/counter/2215573/data/simple_orders?merge_mode=SAVE&delimiter_type=COMMA
    Content-Disposition: form-data; name="file"; filename="data.csv"
    Content-Type: multipart/form-data; boundary=------------------------7zDUQOAIAE9hEWoV
    Context-Length: TBD
    
    --------------------------7zDUQOAIAE9hEWoV
    Content-Disposition: form-data; name="file"; filename="data.csv"
    Content-Type: text/csv
    
    id,create_date_time,client_uniq_id,client_ids,emails,phones,order_status,revenue,cost,goals,currency
    s_ord1,10.01.2024 11:56,s_user1,,"mail@example.com,mail2@example.com",,PAID,200,150,"oplata_cash:200,filial_1",
    s_ord2,20.01.2024 11:59,,12345,mail3@example.com,,,200,150,,EUR
    ,12.02.2024,,34456,,79876543210,SPAM,,,plohoy_lead,
    --------------------------7zDUQOAIAE9hEWoV--
    

Разберем пример отправки

В примере мы отправили три заказа:

#### [](ru/data-import/simple-orders-prep#zakaz-s-id-s_ord1)Заказ с id s_ord1

  * **Дата заказа** : 10.01.2024 11:56
  * **Идентификатор клиента в CRM** : `s_user1`
  * **Почты клиента** : mail@example.com, mail2@example.com
  * **ClientID и телефоны** : отсутствуют
  * **Статус заказа** : `PAID` (будет достигнуты цели **CRM – Заказ Создан** \+ **CRM – Заказ Оплачен**)
  * **Доход** : 200
  * **Себестоимость** : 150 (в целях будет указан доход в 50)
  * **Дополнительно отправлены javascript-цели** : 
    * `oplata_cash` с доходом в 200
    * `filial_1` без дохода (доход по цели будет использован из основных колонок заказа, а именно 200-150=50)
  * **Валюта** : не указана (все доходы будут в рублях)

#### [](ru/data-import/simple-orders-prep#zakaz-s-id-s_ord2)Заказ с id s_ord2

  * **Дата заказа** : 20.01.2024 11:59
  * **Идентификатор клиента в CRM** : не передан
  * **Почта клиента** : mail3@example.com
  * **ClientID** : 12345
  * **Телефоны** : отсутствуют
  * **Статус заказа** : не передан (по умолчанию будет отправлен `PAID`, достигнуты цели: **CRM – Заказ Создан** \+ **CRM – Заказ Оплачен**)
  * **Доход** : 200
  * **Себестоимость** : 150 (в целях будет указан доход в 50)
  * **Дополнительные цели** : отсутствуют
  * **Валюта** : EUR (все доходы будут в евро)

#### [](ru/data-import/simple-orders-prep#zakaz-bez-id)Заказ без id

  * **Дата заказа** : 12.02.2024 (без указания часов/минут — Метрика будет искать для привязки заказа визиты в прошлом, начиная с 12.02.2024 23:59)
  * **Идентификатор клиента в CRM** : не передан
  * **Почта клиента** : mail3@example.com
  * **ClientID** : 34456
  * **Телефон** : 79876543210
  * **Статус заказа** : `SPAM` (цели не будут достигнуты)
  * **Доход и себестоимость** : не указаны
  * **Дополнительно отправлена javascript-цель** : 
    * `plohoy_lead` — будет достигнута без дохода
  * **Валюта** : не указана

### Была ли статья полезна?

ДаНет

Предыдущая

[Передача данных из CRM](contacts.md)

Следующая

[Загрузка упрощенных данных о клиентах и заказах (CSV)](../management/openapi/schema/uploadsimpleorders.md)